#!/usr/bin/env python3
"""
Deepcool LM360 LCD Driver - CLI Tool
Supports temperature display, brightness control, and custom image rendering
"""
import usb.core
import usb.util
import sys
import time
import argparse
import psutil
from PIL import Image, ImageDraw, ImageFont

VENDOR_ID = 0x3633
PRODUCT_ID = 0x0026
EP_OUT = 0x01

# Frame header that works
FRAME_HEADER = bytes([0xaa, 0x08, 0x00, 0x00, 0x01, 0x00, 0x58, 0x02, 0x00, 0x2c, 0x01, 0xbc, 0x11])

class LM360:
    def __init__(self):
        self.dev = None
        self.interface = 0

    def connect(self):
        self.dev = usb.core.find(idVendor=VENDOR_ID, idProduct=PRODUCT_ID)
        if self.dev is None:
            return False
        if self.dev.is_kernel_driver_active(self.interface):
            try:
                self.dev.detach_kernel_driver(self.interface)
            except:
                pass
        try:
            self.dev.set_configuration()
            usb.util.claim_interface(self.dev, self.interface)
        except:
            return False
        return True

    def write(self, data):
        try:
            return self.dev.write(EP_OUT, data, timeout=5000)
        except Exception as e:
            print(f"Write error: {e}")
            return 0

    def send_frame(self, framebuffer):
        """Send a frame to the display"""
        self.write(FRAME_HEADER)
        self.write(framebuffer)

    def brightness_up(self):
        """Increase brightness"""
        cmd = bytes([0xaa, 0x04, 0x00, 0x06, 0x03, 0x61, 0x00, 0xd2, 0x46])
        self.write(cmd)

    def brightness_down(self):
        """Decrease brightness"""
        cmd = bytes([0xaa, 0x04, 0x00, 0x06, 0x03, 0x1d, 0x00, 0xe6, 0x0b])
        self.write(cmd)

    def zen_mode_toggle(self):
        """Toggle Zen mode (screen off/on)"""
        cmd = bytes([0xaa, 0x04, 0x00, 0x03, 0x00, 0x00, 0x00, 0xdc, 0x9b])
        self.write(cmd)

    def init_query(self):
        """Send init/query command"""
        cmd = bytes([0xaa, 0x01, 0x00, 0x09, 0x29, 0x91])
        self.write(cmd)

    def usb_reset(self):
        """Perform USB reset"""
        if self.dev:
            try:
                self.dev.reset()
            except:
                pass

    def disconnect(self):
        if self.dev:
            try:
                usb.util.release_interface(self.dev, self.interface)
                usb.util.dispose_resources(self.dev)
            except:
                pass

def rgb_to_framebuffer(img):
    """Convert PIL RGB image to RGB565 framebuffer"""
    # ALWAYS convert to RGB mode first (handles RGBA, P, L, etc.)
    if img.mode != 'RGB':
        img = img.convert('RGB')

    # Resize if needed
    if img.size != (320, 240):
        img = img.resize((320, 240), Image.Resampling.LANCZOS)

    framebuffer = bytearray()
    pixels = img.load()

    for y in range(240):
        for x in range(320):
            r, g, b = pixels[x, y]
            # Convert to RGB565
            r5 = (r >> 3) & 0x1F
            g6 = (g >> 2) & 0x3F
            b5 = (b >> 3) & 0x1F
            rgb565 = (r5 << 11) | (g6 << 5) | b5
            # Append as little-endian
            framebuffer.append(rgb565 & 0xFF)
            framebuffer.append((rgb565 >> 8) & 0xFF)

    return bytes(framebuffer)

def render_temperature_display(cpu_temp, gpu_temp, cpu_freq):
    """Render temperature display"""
    img = Image.new('RGB', (320, 240), color=(0, 0, 0))
    draw = ImageDraw.Draw(img)

    try:
        font_big = ImageFont.truetype("/usr/share/fonts/TTF/DejaVuSans-Bold.ttf", 70)
        font_med = ImageFont.truetype("/usr/share/fonts/TTF/DejaVuSans.ttf", 24)
    except:
        font_big = ImageFont.load_default()
        font_med = ImageFont.load_default()

    # Separator
    draw.line([(160, 40), (160, 230)], fill=(100, 100, 100), width=2)

    # CPU
    draw.text((20, 80), f"{cpu_temp:.0f}", fill=(0, 255, 0), font=font_big)
    draw.text((30, 170), "CPU °C", fill=(150, 150, 150), font=font_med)

    # GPU
    draw.text((180, 80), f"{gpu_temp:.0f}", fill=(0, 255, 255), font=font_big)
    draw.text((180, 170), "GPU °C", fill=(150, 150, 150), font=font_med)

    # Freq
    draw.text((110, 10), f"{cpu_freq:.1f}GHz", fill=(200, 200, 200), font=font_med)

    return rgb_to_framebuffer(img)

def get_temps():
    try:
        temps = psutil.sensors_temperatures()
        cpu = round(temps['coretemp'][0].current, 1) if 'coretemp' in temps else 0.0
        gpu = round(temps['nvme'][0].current, 1) if 'nvme' in temps else 0.0
        return cpu, gpu
    except:
        return 0.0, 0.0

def get_cpu_freq():
    try:
        freq = psutil.cpu_freq()
        return round(freq.current / 1000, 2) if freq else 0.0
    except:
        return 0.0

def cmd_temps(device, args):
    """Display temperatures continuously"""
    # Send init command first
    device.init_query()
    time.sleep(0.5)

    print("Displaying temperatures (Ctrl+C to stop)...\n")
    try:
        frame_count = 0
        while True:
            cpu_temp, gpu_temp = get_temps()
            cpu_freq = get_cpu_freq()

            framebuffer = render_temperature_display(cpu_temp, gpu_temp, cpu_freq)
            device.send_frame(framebuffer)

            frame_count += 1
            print(f"Frame {frame_count:4d} | CPU: {cpu_temp:5.1f}°C | GPU: {gpu_temp:5.1f}°C | {cpu_freq:.2f}GHz", end='\r')

            time.sleep(args.interval)
    except KeyboardInterrupt:
        print(f"\n\nStopped after {frame_count} frames")

def cmd_image(device, args):
    """Display a custom image"""
    # Send init command first
    device.init_query()
    time.sleep(0.5)

    try:
        img = Image.open(args.image).convert('RGB')
        framebuffer = rgb_to_framebuffer(img)
        device.send_frame(framebuffer)
        print(f"✓ Displayed image: {args.image}")
    except Exception as e:
        print(f"✗ Error loading image: {e}")
        sys.exit(1)

def cmd_solid(device, args):
    """Display solid color"""
    img = Image.new('RGB', (320, 240), color=args.color)
    framebuffer = rgb_to_framebuffer(img)
    device.send_frame(framebuffer)
    print(f"✓ Displayed solid color: {args.color}")

def cmd_brightness(device, args):
    """Adjust brightness"""
    if args.direction == 'up':
        device.brightness_up()
        print("✓ Brightness increased")
    else:
        device.brightness_down()
        print("✓ Brightness decreased")

def cmd_zen(device, args):
    """Toggle Zen mode"""
    device.zen_mode_toggle()
    print("✓ Toggled Zen mode")

def cmd_reset(device, args):
    """Reset/reinitialize the display"""
    print("Resetting display...")

    # Try USB-level reset
    print("  Performing USB reset...")
    device.usb_reset()
    time.sleep(1)

    # Reconnect
    print("  Reconnecting...")
    device.disconnect()
    time.sleep(0.5)

    if not device.connect():
        print("✗ Failed to reconnect after reset")
        return

    # Full init sequence from Windows:
    print("  Sending init sequence...")

    # 1. Brightness up
    device.brightness_up()
    time.sleep(0.2)

    # 2. Init/query
    device.init_query()
    time.sleep(0.5)

    # 3. Send a black frame
    img = Image.new('RGB', (320, 240), color=(0, 0, 0))
    framebuffer = rgb_to_framebuffer(img)
    device.send_frame(framebuffer)

    print("✓ Display reset complete")

def cmd_test(device, args):
    """Test display with color patterns"""
    # Send init first
    device.init_query()
    time.sleep(0.5)

    colors = [
        ('Black', (0, 0, 0)),
        ('White', (255, 255, 255)),
        ('Red', (255, 0, 0)),
        ('Green', (0, 255, 0)),
        ('Blue', (0, 0, 255)),
    ]

    for name, color in colors:
        print(f"Displaying {name}...")
        img = Image.new('RGB', (320, 240), color=color)
        framebuffer = rgb_to_framebuffer(img)
        device.send_frame(framebuffer)
        time.sleep(2)

    print("✓ Test complete")

def main():
    parser = argparse.ArgumentParser(
        description='Deepcool LM360 LCD Driver',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  sudo lm360 temps                    # Display live temperatures
  sudo lm360 temps --interval 1       # Update every second
  sudo lm360 image photo.jpg          # Display custom image
  sudo lm360 solid --color 255 0 0    # Display red screen
  sudo lm360 brightness up            # Increase brightness
  sudo lm360 zen                      # Toggle Zen mode (screen off)
  sudo lm360 test                     # Test with color patterns
        """
    )

    subparsers = parser.add_subparsers(dest='command', help='Command to execute')

    # temps command
    temps_parser = subparsers.add_parser('temps', help='Display temperatures')
    temps_parser.add_argument('--interval', type=float, default=2.0, help='Update interval in seconds (default: 2.0)')

    # image command
    image_parser = subparsers.add_parser('image', help='Display custom image')
    image_parser.add_argument('image', help='Path to image file (will be resized to 320x240)')

    # solid command
    solid_parser = subparsers.add_parser('solid', help='Display solid color')
    solid_parser.add_argument('--color', type=int, nargs=3, metavar=('R', 'G', 'B'),
                             default=[0, 0, 0], help='RGB color (0-255)')

    # brightness command
    brightness_parser = subparsers.add_parser('brightness', help='Adjust brightness')
    brightness_parser.add_argument('direction', choices=['up', 'down'], help='Increase or decrease')

    # zen command
    subparsers.add_parser('zen', help='Toggle Zen mode (screen off/on)')

    # reset command
    subparsers.add_parser('reset', help='Reset/reinitialize the display')

    # test command
    subparsers.add_parser('test', help='Test display with color patterns')

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        sys.exit(1)

    # Connect to device
    device = LM360()
    if not device.connect():
        print("✗ Failed to connect to LM360")
        print("  Make sure:")
        print("  - Device is plugged in (lsusb | grep 3633)")
        print("  - Running with sudo")
        sys.exit(1)

    try:
        # Execute command
        if args.command == 'temps':
            cmd_temps(device, args)
        elif args.command == 'image':
            cmd_image(device, args)
        elif args.command == 'solid':
            cmd_solid(device, args)
        elif args.command == 'brightness':
            cmd_brightness(device, args)
        elif args.command == 'zen':
            cmd_zen(device, args)
        elif args.command == 'reset':
            cmd_reset(device, args)
        elif args.command == 'test':
            cmd_test(device, args)
    finally:
        device.disconnect()

if __name__ == "__main__":
    main()
